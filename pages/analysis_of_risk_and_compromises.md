## 15. Анализ рисков и компромиссов созданной архитектуры

### 1. Ключевые архитектурные риски


|Риск|Описание|Важность|Вероятность|Трудозатраты на митигацию|Последствия принятия риска|Рекомендация|
|-|-|-|-|-------------------------------|-|-|
|Риск «Расползания» модульного монолита|Модульные границы будут нарушены из-за спешки, создавая скрытые зависимости (прямые SQL-джоины между модулями).|Высокая|Высокая|Средние (3-4 чел./мес.) Не технические, а процессные: внедрение архитектурных ревью, линтеры кода, тесты на независимость модулей.|Критическое усложнение будущего расщепления на микросервисы. Фактический отказ от эволюционной стратегии, технический долг.|Принять профилактические меры немедленно. Внедрить ADR-011: Запрет на межмодульные зависимости. Использовать ArchUnit или аналог для автоматической проверки границ.|
|Риск производительности и блокировок в единой БД|Пиковая нагрузка (10k сессий) создаст contention на таблицах workouts и gear, приводя к росту задержек (нарушение NFR-PER-1).|Критическая|Средняя|Высокие (6-8 чел./мес.) Требуется проектирование шардинга, оптимизация индексов, возможно выделение «горячих» таблиц.|Нарушение SLA, плохой пользовательский опыт, невозможность провести массовый челлендж.|Принять как плановую задачу. Заложить в roadmap выделение сервиса тренировок с TimescaleDB на 9-12 месяц. До этого — агрессивное кеширование в Redis и тщательная настройка пула соединений.|
|Риск потери событий при сбое (Event Loss)|Событие WorkoutCompleted будет сгенерировано в приложении, но не доставлено в Kafka из-за сетевого сбоя или падения сервера.|Высокая|Низкая|Средние (2-3 чел./мес.) Реализация паттерна Transactional Outbox или настройка Debezium для CDC.|Нарушение бизнес-процессов: не отправятся уведомления о достижениях, не обновится аналитика. Пользователь не получит обратную связь.|Митигировать обязательно. Выбрать и внедрить Outbox pattern в течение первого квартала после запуска MVP. Без этого не запускать массовые челленджи.|
|Риск сложности отладки в гибридной (sync+async) системе|Инцидент (например, пользователь не получил уведомление) потребует анализа логов в 4+ системах (монолит, Kafka, Notification Service, Redis). MTTR возрастет.|Средняя|Высокая|Высокие (5-7 чел./мес.) Внедрение и настройка полного стека observability (трассировка, логи, метрики) и процедур диагностики.|Увеличение времени простоя (нарушение NFR-REL-1), рост нагрузки на DevOps, недовольство пользователей.|Митигировать до запуска. Внедрение OpenTelemetry и единого дашборда инцидентов — обязательное условие для перехода в production. Бюджет и время на это заложены.|
|Риск vendor lock-in из-за выбора managed-сервисов|Зависимость от AWS MSK (Kafka), ElastiCache (Redis), RDS (PostgreSQL) усложнит или сделает дорогой миграцию на другой cloud.|Низкая|Высокая|Очень высокие (12+ чел./мес.) Отказ от managed-сервисов в пользу self-hosted (K8s операторы) на старте.|Ограничение гибкости, потенциальный рост cost в долгосрочной перспективе. Но соответствует текущей политике компании (использовать лучшее под задачу).|Принять как осознанный компромисс. Выгода от managed-сервисов (скорость выхода, снижение ops-нагрузки) для MVP перевешивает риски. Обеспечить логическую переносимость (использовать стандартные клиенты БД, готовить Docker-образы).|



### 2. Ключевые архитектурные компромиссы (Trade-offs)
|Компромисс|Выбранная сторона|Альтернатива|Обоснование выбора| Последствия и меры контроля |
|-|-|-|-|-------------------------------|
|Гибкость vs. Сложность (микросервисы сейчас vs. позже)|Скорость выхода (Time-to-Market). Старт с модульного монолита.|Запуск с полноценными микросервисами с Day 1.|Бизнес требует быстрого запуска MVP для проверки гипотез по монетизации. Полная МСА отложила бы запуск на 6+ месяцев.|Риск: Усложнение будущей миграции. Контроль: Строгая модульность, Event-Driven интерфейсы с Day 1, план миграции в roadmap.|
|Согласованность vs. Доступность (CAP-теорема)|Доступность и Partition Tolerance (AP-система). Eventual consistency для межсервисного взаимодействия.|Строгая согласованность (CP) через распределенные транзакции (Saga, 2PC)|Для социальных функций и геймификации задержка в несколько секунд в доставке события приемлема. Критичная согласованность (баланс счета) не нужна.|Риск: Пользователь может не сразу увидеть свой новый badge. Контроль: Четкие UX-паттерны (скелетоны, «обновление...»).|
|Стоимость vs. Масштабируемость инфраструктуры|Управляемая стоимость на старте. Multi-AZ, но не Multi-Region. Активно-пассивная DR.|Полноценная Multi-Region Active-Active архитектура для MVP.|Бюджет MVP ограничен. Пиковые нагрузки в одном регионе управляемы. NFR-REL-2 (RTO 30 мин) выполняется за счет пассивного региона.|Риск: Высокая задержка для пользователей в других регионах. Контроль: CDN для статики, четкий план расширения при достижении 20% трафика из нового региона.|
|Безопасность vs. Удобство разработки|Безопасность по умолчанию. Шифрование PII в БД, Vault для секретов, обязательные ревью.|Упрощённая безопасность на старпе для ускорения разработки.|Данные о здоровье и геолокации — критичны. Репутационный риск (BR-4) перевешивает неудобство для разработчиков.|Риск: Замедление скорости разработки. Контроль: Инвестиции в DevSecOps: автоматические шаблоны сервисов с включенной безопасностью, Security Champions в командах.|
|Универсальность vs. Специализация хранилищ (Polyglot Persistence)|Специализация. Отдельные хранилища под задачу (PostgreSQL, Redis, ClickHouse, S3).|Универсальная БД (например, только PostgreSQL для всего).|Аргумент за: Оптимальная производительность и стоимость. workouts в TimescaleDB, социальный граф — в графовой БД. Аргумент против: Рост операционной сложности.|Риск: Усложнение эксплуатации и бэкапов. Контроль: Выделенная платформенная команда (Platform Team) для управления жизненным циклом хранилищ.|


### 3. Сводный анализ по трудозатратам и приоритету
- Критические риски, требующие немедленного внимания (высокая важность, средняя/высокая вероятность):
- 1. Производительность БД: Трудозатраты высокие (6-8 чел./мес.), но откладывание неприемлемо. Начинать прототипирование шардинга/TimescaleDB параллельно с разработкой MVP.
- 2. Потеря событий: Трудозатраты средние (2-3 чел./мес.). Должен быть реализован до любого массового мероприятия. Приоритет — высокий.

- Системные риски, требующие процессных изменений (высокая вероятность):
- 1. «Расползание» монолита: Трудозатраты средние (3-4 чел./мес.), в основном на внедрение процессов. Запустить немедленно.
- 2. Сложность отладки: Трудозатраты высокие (5-7 чел./мес.). Является блокером для production. Финансирование и ресурсы должны быть выделены с самого начала.

- Стратегические компромиссы (приняты осознанно):
- 1. Vendor lock-in и отложенная глобальность — это бизнес-решения, а не просчёты архитектуры. Они документированы в ADR и имеют четкие триггеры для пересмотра (например, рост затрат на AWS > X%, или трафик из ЕС > 20%).
